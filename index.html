<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catalogue - Love Mon Bijou</title>
<style>
    body { 
        font-family: Arial, sans-serif; 
        margin: 20px;
        background-color: #f9f9f9;
    }
    h1 { 
        color: #333;
        text-align: center;
    }
    .filters {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    select { 
        margin: 10px 5px; 
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    table { 
        border-collapse: collapse; 
        width: 100%; 
        margin-top: 15px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    th, td { 
        border: 1px solid #ddd; 
        padding: 12px; 
        text-align: left; 
    }
    th {
        background-color: #4CAF50;
        color: white;
    }
    tr:hover {
        background-color: #f5f5f5;
    }
    button { 
        padding: 8px 15px; 
        margin: 5px; 
        cursor: pointer;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
    }
    button:hover {
        background-color: #45a049;
    }
    #cart { 
        margin-top: 20px; 
        border: 1px solid #ddd; 
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #cartList {
        list-style: none;
        padding: 0;
    }
    #cartList li {
        padding: 8px;
        border-bottom: 1px solid #eee;
    }
    #checkoutBtn {
        background-color: #ff9800;
        font-size: 16px;
        padding: 12px 24px;
    }
    #checkoutBtn:hover {
        background-color: #e68900;
    }
    .loading {
        text-align: center;
        padding: 40px;
        font-size: 18px;
        color: #666;
    }
</style>
</head>
<body>

<h1>üíé Catalogue Love Mon Bijou</h1>

<div class="filters">
    <label for="typeSelect">Type de bijou:</label>
    <select id="typeSelect">
        <option value="">-- Tous les types --</option>
    </select>

    <label for="titleSelect">Titre:</label>
    <select id="titleSelect">
        <option value="">-- Tous les titres --</option>
    </select>

    <label for="priceSort">Trier par prix:</label>
    <select id="priceSort">
        <option value="">-- Aucun tri --</option>
        <option value="asc">Prix croissant</option>
        <option value="desc">Prix d√©croissant</option>
    </select>
</div>

<div id="loading" class="loading">Chargement du catalogue...</div>

<table id="productTable" style="display:none;">
    <thead>
        <tr>
            <th>Type</th>
            <th>Titre</th>
            <th>Couleur</th>
            <th>Poids Or</th>
            <th>Pierres</th>
            <th>Tailles</th>
            <th>Prix (‚Ç¨)</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div id="cart">
    <h2>üõí Panier</h2>
    <ul id="cartList"></ul>
    <p><strong>Total: ‚Ç¨<span id="cartTotal">0.00</span></strong></p>
    <button id="checkoutBtn">Valider la commande</button>
</div>

<script>
let products = [];
let cart = [];

// Charger les produits depuis Netlify Function
async function loadProducts() {
    try {
        console.log('üîÑ Chargement des produits...');
        const res = await fetch('/.netlify/functions/get-products');
        
        if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        console.log('‚úÖ Donn√©es re√ßues:', data);
        
        if (data.success && data.products) {
            products = data.products;
        } else {
            products = data; // Si format simple
        }
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('productTable').style.display = 'table';
        
        populateTypeDropdown();
        populateTable();
        
    } catch (err) {
        console.error('‚ùå Erreur:', err);
        document.getElementById('loading').innerHTML = `
            <div style="color: red;">
                <h3>Erreur de chargement</h3>
                <p>${err.message}</p>
                <button onclick="location.reload()">R√©essayer</button>
            </div>
        `;
    }
}

function populateTypeDropdown() {
    const typeSelect = document.getElementById('typeSelect');
    const types = [...new Set(products.map(p => p.type).filter(Boolean))];
    
    types.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        typeSelect.appendChild(option);
    });
}

function populateTitleDropdown(selectedType) {
    const titleSelect = document.getElementById('titleSelect');
    titleSelect.innerHTML = '<option value="">-- Tous les titres --</option>';
    
    const filtered = selectedType 
        ? products.filter(p => p.type === selectedType) 
        : products;
    
    const titles = [...new Set(filtered.map(p => p.titre).filter(Boolean))];
    
    titles.forEach(title => {
        const option = document.createElement('option');
        option.value = title;
        option.textContent = title;
        titleSelect.appendChild(option);
    });
}

function formatSizes(product) {
    if (!product.sizes || product.sizes.length === 0) {
        return '-';
    }
    
    if (product.quantityPerSize && product.quantityPerSize.length > 0) {
        return product.sizes.map((size, i) => 
            `${size}: ${product.quantityPerSize[i] || '?'}`
        ).join('<br>');
    }
    
    return product.sizes.join(', ');
}

function formatPierres(pierres) {
    if (!pierres || pierres.length === 0) return '-';
    return Array.isArray(pierres) ? pierres.join(', ') : pierres;
}

function populateTable() {
    const tbody = document.querySelector('#productTable tbody');
    tbody.innerHTML = '';

    const selectedType = document.getElementById('typeSelect').value;
    const selectedTitle = document.getElementById('titleSelect').value;
    const priceSort = document.getElementById('priceSort').value;

    let filtered = products;
    
    if (selectedType) {
        filtered = filtered.filter(p => p.type === selectedType);
    }
    
    if (selectedTitle) {
        filtered = filtered.filter(p => p.titre === selectedTitle);
    }

    // ‚úÖ CORRIG√â : tri sur p.price
    if (priceSort === 'asc') {
        filtered.sort((a, b) => a.price - b.price);
    }
    if (priceSort === 'desc') {
        filtered.sort((a, b) => b.price - a.price);
    }

    filtered.forEach((p, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${p.type || '-'}</td>
            <td><strong>${p.titre || 'Sans titre'}</strong></td>
            <td>${p.couleur || '-'}</td>
            <td>${p.poids || '-'}</td>
            <td>${formatPierres(p.pierres)}</td>
            <td>${formatSizes(p)}</td>
            <td><strong>${p.price ? p.price.toFixed(2) : '0.00'}</strong></td>
            <td><button data-index="${index}">Ajouter au panier</button></td>
        `;
        tbody.appendChild(tr);
    });

    // Ajouter les √©v√©nements sur les boutons
    document.querySelectorAll('#productTable button').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const idx = e.target.getAttribute('data-index');
            addToCart(filtered[idx]);
        });
    });
}

function addToCart(product) {
    cart.push(product);
    updateCart();
    alert(`‚úÖ "${product.titre}" ajout√© au panier !`);
}

function updateCart() {
    const cartList = document.getElementById('cartList');
    cartList.innerHTML = '';
    let total = 0;
    
    cart.forEach((p, index) => {
        const li = document.createElement('li');
        // ‚úÖ CORRIG√â : p.price au lieu de p.priceSort
        li.innerHTML = `
            ${p.titre} - ‚Ç¨${p.price.toFixed(2)}
            <button onclick="removeFromCart(${index})" style="background:red;padding:3px 8px;font-size:12px;">‚úï</button>
        `;
        cartList.appendChild(li);
        total += p.price;
    });
    
    document.getElementById('cartTotal').textContent = total.toFixed(2);
}

function removeFromCart(index) {
    cart.splice(index, 1);
    updateCart();
}

// Envoyer la commande
document.getElementById('checkoutBtn').addEventListener('click', async () => {
    if (cart.length === 0) {
        alert('‚ö†Ô∏è Votre panier est vide.');
        return;
    }

    if (!confirm(`Confirmer la commande de ${cart.length} article(s) ?`)) {
        return;
    }

    try {
        const res = await fetch('/.netlify/functions/send-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cart })
        });

        const result = await res.json();
        
        if (result.success) {
            alert('‚úÖ ' + (result.message || 'Commande envoy√©e avec succ√®s !'));
            cart = [];
            updateCart();
        } else {
            alert('‚ùå ' + (result.error || 'Erreur lors de l\'envoi'));
        }
        
    } catch (err) {
        console.error(err);
        alert('‚ùå Erreur lors de l\'envoi de la commande.');
    }
});

// √âv√©nements des filtres
document.getElementById('typeSelect').addEventListener('change', e => {
    populateTitleDropdown(e.target.value);
    populateTable();
});

document.getElementById('titleSelect').addEventListener('change', populateTable);
document.getElementById('priceSort').addEventListener('change', populateTable);

// Charger au d√©marrage
loadProducts();
</script>

</body>
</html>