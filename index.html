<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catalogue Interactif</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #333; }
    select { margin: 10px 5px; padding: 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #333; padding: 8px; text-align: left; }
    button { padding: 5px 10px; margin: 5px; cursor: pointer; }
    #cart { margin-top: 20px; border: 1px solid #333; padding: 10px; }
</style>
</head>
<body>

<h1>Catalogue Interactif</h1>

<label for="typeSelect">Type de produit:</label>
<select id="typeSelect">
    <option value="">--Tous les types--</option>
</select>

<label for="titleSelect">Titre du produit:</label>
<select id="titleSelect">
    <option value="">--Tous les titres--</option>
</select>

<label for="priceSort">Trier par prix:</label>
<select id="priceSort">
    <option value="">--Aucun--</option>
    <option value="asc">Prix croissant</option>
    <option value="desc">Prix décroissant</option>
</select>

<table id="productTable">
    <thead>
        <tr>
            <th>Titre</th>
            <th>Couleur</th>
            <th>Or</th>
            <th>Poids</th>
            <th>Quantités par taille</th>
            <th>Prix (€)</th>
            <th>Ajouter au panier</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div id="cart">
    <h2>Panier</h2>
    <ul id="cartList"></ul>
    <p>Total: €<span id="cartTotal">0.00</span></p>
    <button id="checkoutBtn">Valider la commande</button>
</div>

<script>
let products = [];
let cart = [];

// Charger les produits depuis Netlify Function
async function loadProducts() {
    try {
        const res = await fetch('/.netlify/functions/get-products');
        if (!res.ok) throw new Error('Erreur lors du chargement des produits');
        products = await res.json();
        populateTypeDropdown();
        populateTable();
    } catch (err) {
        console.error(err);
        alert('Impossible de charger le catalogue. Vérifiez la console.');
    }
}

function populateTypeDropdown() {
    const typeSelect = document.getElementById('typeSelect');
    const types = [...new Set(products.map(p => p.couleur))];
    types.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        typeSelect.appendChild(option);
    });
}

function populateTitleDropdown(selectedType) {
    const titleSelect = document.getElementById('titleSelect');
    titleSelect.innerHTML = '<option value="">--Tous les titres--</option>';
    const filtered = selectedType ? products.filter(p => p.couleur === selectedType) : products;
    const titles = [...new Set(filtered.map(p => p.titre))];
    titles.forEach(title => {
        const option = document.createElement('option');
        option.value = title;
        option.textContent = title;
        titleSelect.appendChild(option);
    });
}

function parseSizes(sizesField) {
    if (!sizesField) return '';
    try {
        const sizesArray = JSON.parse(sizesField);
        return sizesArray.map(s => `${s.size}: ${s.quantity}`).join('<br>');
    } catch (err) {
        console.warn('Impossible de parser les tailles:', sizesField);
        return sizesField;
    }
}

function populateTable() {
    const tbody = document.querySelector('#productTable tbody');
    tbody.innerHTML = '';

    const selectedType = document.getElementById('typeSelect').value;
    const selectedTitle = document.getElementById('titleSelect').value;
    const priceSort = document.getElementById('priceSort').value;

    let filtered = products;
    if (selectedType) filtered = filtered.filter(p => p.couleur === selectedType);
    if (selectedTitle) filtered = filtered.filter(p => p.titre === selectedTitle);

    if (priceSort === 'asc') filtered.sort((a, b) => a.prix - b.prix);
    if (priceSort === 'desc') filtered.sort((a, b) => b.prix - a.prix);

    filtered.forEach((p, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${p.titre}</td>
            <td>${p.couleur}</td>
            <td>${p.or}</td>
            <td>${p.poids}</td>
            <td>${parseSizes(p.autre_pierre)}</td>
            <td>${p.prix.toFixed(2)}</td>
            <td><button data-index="${index}">Ajouter</button></td>
        `;
        tbody.appendChild(tr);
    });

    document.querySelectorAll('#productTable button').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const idx = e.target.getAttribute('data-index');
            addToCart(products[idx]);
        });
    });
}

function addToCart(product) {
    cart.push(product);
    updateCart();
}

function updateCart() {
    const cartList = document.getElementById('cartList');
    cartList.innerHTML = '';
    let total = 0;
    cart.forEach((p) => {
        const li = document.createElement('li');
        li.textContent = `${p.titre} - €${p.prix.toFixed(2)}`;
        cartList.appendChild(li);
        total += p.prix;
    });
    document.getElementById('cartTotal').textContent = total.toFixed(2);
}

// Envoyer la commande via Netlify Function + Infomaniak SMTP
document.getElementById('checkoutBtn').addEventListener('click', async () => {
    if (cart.length === 0) {
        alert('Votre panier est vide.');
        return;
    }

    try {
        const res = await fetch('/.netlify/functions/send-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cart })
        });

        const result = await res.json();
        alert(result.message || 'Commande envoyée !');
        cart = [];
        updateCart();
    } catch (err) {
        console.error(err);
        alert('Erreur lors de l’envoi de la commande.');
    }
});

document.getElementById('typeSelect').addEventListener('change', e => {
    const type = e.target.value;
    populateTitleDropdown(type);
    populateTable();
});
document.getElementById('titleSelect').addEventListener('change', populateTable);
document.getElementById('priceSort').addEventListener('change', populateTable);

loadProducts();
</script>

</body>
</html>
