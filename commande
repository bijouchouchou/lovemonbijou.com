<main>
  <h1>Catalogue Interactif avec Commande</h1>

  <div>
    <label for="titleSelect">Produit :</label>
    <select id="titleSelect">
      <option value="">--Tous les produits--</option>
    </select>

    <label for="priceSort">Trier par prix :</label>
    <select id="priceSort">
      <option value="">--Aucun--</option>
      <option value="asc">Prix croissant</option>
      <option value="desc">Prix décroissant</option>
    </select>
  </div>

  <table id="productTable">
    <thead>
      <tr>
        <th>Produit</th>
        <th>Description</th>
        <th>Tailles disponibles</th>
        <th>Prix (€)</th>
        <th>Taille</th>
        <th>Quantité</th>
        <th>Commander</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let products = [];
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');

    async function loadProducts() {
      try {
        const res = await fetch('/.netlify/functions/get-products');
        if (!res.ok) throw new Error('Erreur lors du chargement des produits');
        products = await res.json();
        populateTitleDropdown();
        populateTable();
      } catch (err) {
        console.error(err);
        alert('Impossible de charger le catalogue. Vérifiez la console.');
      }
    }

    function populateTitleDropdown() {
      const titleSelect = document.getElementById('titleSelect');
      const titles = [...new Set(products.map(p => p.name))];
      titles.forEach(title => {
        const option = document.createElement('option');
        option.value = title;
        option.textContent = title;
        titleSelect.appendChild(option);
      });
    }

    function addToCart(productId, selectedSize, quantity) {
      const product = products.find(p => p.id === productId);
      if (!product) return alert('Produit introuvable');
      if (!selectedSize) return alert('Veuillez sélectionner une taille.');
      if (!quantity || quantity < 1) return alert('Veuillez saisir une quantité valide.');

      cart.push({
        id: product.id,
        name: product.name,
        price: product.price,
        size: selectedSize,
        quantity: parseInt(quantity, 10)
      });

      localStorage.setItem('cart', JSON.stringify(cart));
      alert(`"${product.name}" (${selectedSize}) x${quantity} ajouté au panier !`);
    }

    function populateTable() {
      const tbody = document.querySelector('#productTable tbody');
      tbody.innerHTML = '';

      const selectedTitle = document.getElementById('titleSelect').value;
      const priceSort = document.getElementById('priceSort').value;

      let filtered = products;
      if (selectedTitle) filtered = filtered.filter(p => p.name === selectedTitle);

      if (priceSort === 'asc') filtered.sort((a, b) => a.price - b.price);
      if (priceSort === 'desc') filtered.sort((a, b) => b.price - a.price);

      filtered.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.description}</td>
          <td>${p.sizes.join(', ')}</td>
          <td>${p.price.toFixed(2)}</td>
          <td>
            <select class="sizeSelect">
              <option value="">--Choisir--</option>
              ${p.sizes.map(size => `<option value="${size}">${size}</option>`).join('')}
            </select>
          </td>
          <td><input type="number" class="qtyInput" min="1" value="1" style="width:50px"></td>
          <td><button class="orderBtn">Commander</button></td>
        `;
        tbody.appendChild(tr);

        const btn = tr.querySelector('.orderBtn');
        const select = tr.querySelector('.sizeSelect');
        const qtyInput = tr.querySelector('.qtyInput');
        btn.addEventListener('click', () => {
          addToCart(p.id, select.value, qtyInput.value);
        });
      });
    }

    document.getElementById('titleSelect').addEventListener('change', populateTable);
    document.getElementById('priceSort').addEventListener('change', populateTable);

    loadProducts();
  </script>
</main>
